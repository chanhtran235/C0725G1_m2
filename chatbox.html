<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Chat với Ollama</title>
</head>
<body>
<h2>=== Chat với Ollama (model: tinyllama) ===</h2>
<div id="chatBox" style="border:1px solid #ccc; padding:10px; width:500px; height:300px; overflow-y:auto;"></div>
<input type="text" id="userInput" placeholder="Nhập tin nhắn..." style="width:400px;">
<button onclick="sendMessage()">Gửi</button>

<script>
    let messages = [];

    async function sendMessage() {
        const input = document.getElementById("userInput");
        const chatBox = document.getElementById("chatBox");
        const userText = input.value.trim();

        if (!userText) return;

        // Hiển thị user message
        chatBox.innerHTML += `<p><b>Bạn:</b> ${userText}</p>`;
        input.value = "";

        // Thêm vào history
        messages.push({ role: "user", content: userText });

        // Chuẩn bị request body
        const body = {
            model: "tinyllama",
            messages: [
                { role: "system", content: "Bạn là một trợ lý AI thân thiện. Hãy luôn trả lời bằng tiếng Việt." },
                ...messages
            ]
        };

        try {
            const response = await fetch("http://localhost:11434/api/chat", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(body)
            });

            const text = await response.text();

            // Gom tất cả "content"
            const regex = /"content":"(.*?)"/g;
            let match;
            let reply = "";
            while ((match = regex.exec(text)) !== null) {
                reply += match[1];
            }

            // Hiển thị trả lời
            chatBox.innerHTML += `<p><b>Ollama:</b> ${reply}</p>`;
            chatBox.scrollTop = chatBox.scrollHeight;

            // Lưu vào history
            messages.push({ role: "assistant", content: reply });

        } catch (err) {
            chatBox.innerHTML += `<p style="color:red;">Lỗi: ${err.message}</p>`;
        }
    }
</script>
</body>
</html>
