<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Chat Streaming với Ollama</title>
</head>
<body>
<h2>=== Chat với Ollama (model: tinyllama) ===</h2>
<div id="chatBox" style="border:1px solid #ccc; padding:10px; width:500px; height:300px; overflow-y:auto;"></div>
<input type="text" id="userInput" placeholder="Nhập tin nhắn..." style="width:400px;">
<button onclick="sendMessage()">Gửi</button>

<script>
    document.getElementById("userInput").addEventListener("keydown", function(event) {
        if (event.key === "Enter") {
            event.preventDefault(); // Không xuống dòng
            sendMessage();
        }
    });
    let messages = [];

    async function sendMessage() {
        const input = document.getElementById("userInput");
        const chatBox = document.getElementById("chatBox");
        const userText = input.value.trim();
        if (!userText) return;

        // Hiển thị user
        chatBox.innerHTML += `<p><b>Bạn:</b> ${userText}</p>`;
        input.value = "";

        // Thêm vào history
        messages.push({ role: "user", content: userText });

        // Tạo thẻ mới để hiển thị reply (stream dần vào đây)
        const replyElement = document.createElement("p");
        replyElement.innerHTML = "<b>Ollama:</b> ";
        chatBox.appendChild(replyElement);
        chatBox.scrollTop = chatBox.scrollHeight;

        // Body request
        const body = {
            model: "tinyllama",
            messages: [
                { role: "system", content: "Tôi là một trợ lý AI thân thiện" },
                ...messages
            ],
            stream: true   // ⚠️ Bắt buộc để nhận streaming
        };

        const response = await fetch("http://localhost:11434/api/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
        });

        const reader = response.body.getReader();
        const decoder = new TextDecoder("utf-8");
        let fullReply = "";

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value, { stream: true });
            const lines = chunk.split("\n").filter(line => line.trim() !== "");

            for (const line of lines) {
                try {
                    const data = JSON.parse(line);
                    if (data.message && data.message.content) {
                        const token = data.message.content;
                        fullReply += token;
                        replyElement.innerHTML += token; // Hiện từng token
                        chatBox.scrollTop = chatBox.scrollHeight;
                    }
                } catch (e) {
                    console.error("Không parse được:", line, e);
                }
            }
        }

        // Lưu vào history
        messages.push({ role: "assistant", content: fullReply });
    }
</script>
</body>
</html>
